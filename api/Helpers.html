---
layout: default
title: "Helpers API"
categories:
  - api
---
   <div class="row-fluid">     <div class="page-title documentation-page-title">       <div class="container">         <h1 class="page-title__title">API Documentation</h1>         <a href="https://github.com/noflo/noflo/blob/master/src/lib/Helpers.coffee" class="btn btn-primary page-title__button big-button">On GitHub</a>       </div>     </div>   </div>    <div class="row-fluid">     <div class="container documentation-main-container">       <div class="main">         <div class="sidebar span4">                    <nav>             <ul class="sidebar__nav">                                                                  <li>                   <a {% if page.url == '/api/ArrayPort/index.html' %}class="active" {% endif %}href="/api/ArrayPort/">                     ArrayPort                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/AsyncComponent/index.html' %}class="active" {% endif %}href="/api/AsyncComponent/">                     AsyncComponent                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/BasePort/index.html' %}class="active" {% endif %}href="/api/BasePort/">                     BasePort                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/Component/index.html' %}class="active" {% endif %}href="/api/Component/">                     Component                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/ComponentLoader/index.html' %}class="active" {% endif %}href="/api/ComponentLoader/">                     ComponentLoader                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/Graph/index.html' %}class="active" {% endif %}href="/api/Graph/">                     Graph                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/Helpers/index.html' %}class="active" {% endif %}href="/api/Helpers/">                     Helpers                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/IP/index.html' %}class="active" {% endif %}href="/api/IP/">                     IP                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/InPort/index.html' %}class="active" {% endif %}href="/api/InPort/">                     InPort                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/InternalSocket/index.html' %}class="active" {% endif %}href="/api/InternalSocket/">                     InternalSocket                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/Journal/index.html' %}class="active" {% endif %}href="/api/Journal/">                     Journal                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/Network/index.html' %}class="active" {% endif %}href="/api/Network/">                     Network                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/NoFlo/index.html' %}class="active" {% endif %}href="/api/NoFlo/">                     NoFlo                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/OutPort/index.html' %}class="active" {% endif %}href="/api/OutPort/">                     OutPort                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/Platform/index.html' %}class="active" {% endif %}href="/api/Platform/">                     Platform                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/Port/index.html' %}class="active" {% endif %}href="/api/Port/">                     Port                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/Ports/index.html' %}class="active" {% endif %}href="/api/Ports/">                     Ports                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/Streams/index.html' %}class="active" {% endif %}href="/api/Streams/">                     Streams                   </a>                 </li>                                                                                   <li>                   <a {% if page.url == '/api/Utils/index.html' %}class="active" {% endif %}href="/api/Utils/">                     Utils                   </a>                 </li>                                             </ul>           </nav>                  </div>         <div class="content span8">           <h1>{{ page.title }}</h1>                                     <pre><code>NoFlo - Flow-Based Programming for JavaScript
(c) 2014-2015 TheGrid (Rituwall Inc.)
NoFlo may be freely distributed under the MIT license
</code></pre>                            <div class="highlight"><pre><span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;underscore&#39;</span>
<span class="nx">StreamSender</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./Streams&#39;</span><span class="p">).</span><span class="nx">StreamSender</span>
<span class="nx">StreamReceiver</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./Streams&#39;</span><span class="p">).</span><span class="nx">StreamReceiver</span>
<span class="nx">InternalSocket</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;./InternalSocket&#39;</span>

<span class="nx">isArray</span> <span class="o">=</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="k">if</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span>
  <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arg</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;[object Array]&#39;</span></pre></div>                                                  <p>MapComponent maps a single inport to a single outport, forwarding all
groups from in to out and calling <code>func</code> on each incoming packet</p>                            <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">MapComponent</span> <span class="o">=</span> <span class="p">(</span><span class="nx">component</span><span class="p">,</span> <span class="nx">func</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nx">config</span> <span class="o">=</span> <span class="p">{}</span> <span class="nx">unless</span> <span class="nx">config</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">inPort</span> <span class="o">=</span> <span class="s1">&#39;in&#39;</span> <span class="nx">unless</span> <span class="nx">config</span><span class="p">.</span><span class="nx">inPort</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">outPort</span> <span class="o">=</span> <span class="s1">&#39;out&#39;</span> <span class="nx">unless</span> <span class="nx">config</span><span class="p">.</span><span class="nx">outPort</span>

  <span class="nx">inPort</span> <span class="o">=</span> <span class="nx">component</span><span class="p">.</span><span class="nx">inPorts</span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">inPort</span><span class="p">]</span>
  <span class="nx">outPort</span> <span class="o">=</span> <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">outPort</span><span class="p">]</span>
  <span class="nx">groups</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nx">inPort</span><span class="p">.</span><span class="nx">process</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">payload</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">switch</span> <span class="nx">event</span>
      <span class="k">when</span> <span class="s1">&#39;connect&#39;</span> <span class="k">then</span> <span class="nx">outPort</span><span class="p">.</span><span class="nx">connect</span><span class="p">()</span>
      <span class="k">when</span> <span class="s1">&#39;begingroup&#39;</span>
        <span class="nx">groups</span><span class="p">.</span><span class="nx">push</span> <span class="nx">payload</span>
        <span class="nx">outPort</span><span class="p">.</span><span class="nx">beginGroup</span> <span class="nx">payload</span>
      <span class="k">when</span> <span class="s1">&#39;data&#39;</span>
        <span class="nx">func</span> <span class="nx">payload</span><span class="p">,</span> <span class="nx">groups</span><span class="p">,</span> <span class="nx">outPort</span>
      <span class="k">when</span> <span class="s1">&#39;endgroup&#39;</span>
        <span class="nx">groups</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
        <span class="nx">outPort</span><span class="p">.</span><span class="nx">endGroup</span><span class="p">()</span>
      <span class="k">when</span> <span class="s1">&#39;disconnect&#39;</span>
        <span class="nx">groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nx">outPort</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">()</span></pre></div>                                                  <p>WirePattern makes your component collect data from several inports
and activates a handler <code>proc</code> only when a tuple from all of these
ports is complete. The signature of handler function is:
<code>
proc = (combinedInputData, inputGroups, outputPorts, asyncCallback) -&gt;
</code></p>

<p>With <code>config.group = true</code> it checks incoming group IPs and collates
data with matching group IPs. By default this kind of grouping is <code>false</code>.
Set <code>config.group</code> to a RegExp object to correlate inputs only if the
group matches the expression (e.g. <code>^req_</code>). For non-matching groups
the component will act normally.</p>

<p>With `config.field = 'fieldName' it collates incoming data by specified
field. The component's proc function is passed a combined object with
port names used as keys. This kind of grouping is disabled by default.</p>

<p>With <code>config.forwardGroups = true</code> it would forward group IPs from
inputs to the output sending them along with the data. This option also
accepts string or array values, if you want to forward groups from specific
port(s) only. By default group forwarding is <code>false</code>.</p>

<p><code>config.receiveStreams = [portNames]</code> feature makes the component expect
substreams on specific inports instead of separate IPs (brackets and data).
It makes select inports emit <code>Substream</code> objects on <code>data</code> event
and silences <code>beginGroup</code> and <code>endGroup</code> events.</p>

<p><code>config.sendStreams = [portNames]</code> feature makes the component emit entire
substreams of packets atomically to the outport. Atomically means that a
substream cannot be interrupted by other packets, which is important when
doing asynchronous processing. In fact, <code>sendStreams</code> is enabled by default
on all outports when <code>config.async</code> is <code>true</code>.</p>

<p>WirePattern supports both sync and async <code>proc</code> handlers. In latter case
pass <code>config.async = true</code> and make sure that <code>proc</code> accepts callback as
4th parameter and calls it when async operation completes or fails.</p>

<p>WirePattern sends group packets, sends data packets emitted by <code>proc</code>
via its <code>outputPort</code> argument, then closes groups and disconnects
automatically.</p>                            <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">WirePattern</span> <span class="o">=</span> <span class="p">(</span><span class="nx">component</span><span class="p">,</span> <span class="nx">config</span><span class="p">,</span> <span class="nx">proc</span><span class="p">)</span> <span class="o">-&gt;</span></pre></div>                                                  <p>In ports</p>                            <div class="highlight"><pre>  <span class="nx">inPorts</span> <span class="o">=</span> <span class="k">if</span> <span class="s1">&#39;in&#39;</span> <span class="k">of</span> <span class="nx">config</span> <span class="k">then</span> <span class="nx">config</span><span class="p">.</span><span class="k">in</span> <span class="k">else</span> <span class="s1">&#39;in&#39;</span>
  <span class="nx">inPorts</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">inPorts</span> <span class="p">]</span> <span class="nx">unless</span> <span class="nx">isArray</span> <span class="nx">inPorts</span></pre></div>                                                  <p>Out ports</p>                            <div class="highlight"><pre>  <span class="nx">outPorts</span> <span class="o">=</span> <span class="k">if</span> <span class="s1">&#39;out&#39;</span> <span class="k">of</span> <span class="nx">config</span> <span class="k">then</span> <span class="nx">config</span><span class="p">.</span><span class="nx">out</span> <span class="k">else</span> <span class="s1">&#39;out&#39;</span>
  <span class="nx">outPorts</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">outPorts</span> <span class="p">]</span> <span class="nx">unless</span> <span class="nx">isArray</span> <span class="nx">outPorts</span></pre></div>                                                  <p>Error port</p>                            <div class="highlight"><pre>  <span class="nx">config</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="s1">&#39;error&#39;</span> <span class="nx">unless</span> <span class="s1">&#39;error&#39;</span> <span class="k">of</span> <span class="nx">config</span></pre></div>                                                  <p>For async process</p>                            <div class="highlight"><pre>  <span class="nx">config</span><span class="p">.</span><span class="nx">async</span> <span class="o">=</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="s1">&#39;async&#39;</span> <span class="k">of</span> <span class="nx">config</span></pre></div>                                                  <p>Keep correct output order for async mode</p>                            <div class="highlight"><pre>  <span class="nx">config</span><span class="p">.</span><span class="nx">ordered</span> <span class="o">=</span> <span class="kc">true</span> <span class="nx">unless</span> <span class="s1">&#39;ordered&#39;</span> <span class="k">of</span> <span class="nx">config</span></pre></div>                                                  <p>Group requests by group ID</p>                            <div class="highlight"><pre>  <span class="nx">config</span><span class="p">.</span><span class="nx">group</span> <span class="o">=</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="s1">&#39;group&#39;</span> <span class="k">of</span> <span class="nx">config</span></pre></div>                                                  <p>Group requests by object field</p>                            <div class="highlight"><pre>  <span class="nx">config</span><span class="p">.</span><span class="nx">field</span> <span class="o">=</span> <span class="kc">null</span> <span class="nx">unless</span> <span class="s1">&#39;field&#39;</span> <span class="k">of</span> <span class="nx">config</span></pre></div>                                                  <p>Forward group events from specific inputs to the output:
- false: don't forward anything
- true: forward unique groups of all inputs
- string: forward groups of a specific port only
- array: forward unique groups of inports in the list</p>                            <div class="highlight"><pre>  <span class="nx">config</span><span class="p">.</span><span class="nx">forwardGroups</span> <span class="o">=</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="s1">&#39;forwardGroups&#39;</span> <span class="k">of</span> <span class="nx">config</span></pre></div>                                                  <p>Receive streams feature</p>                            <div class="highlight"><pre>  <span class="nx">config</span><span class="p">.</span><span class="nx">receiveStreams</span> <span class="o">=</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="s1">&#39;receiveStreams&#39;</span> <span class="k">of</span> <span class="nx">config</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">config</span><span class="p">.</span><span class="nx">receiveStreams</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
    <span class="nx">config</span><span class="p">.</span><span class="nx">receiveStreams</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">config</span><span class="p">.</span><span class="nx">receiveStreams</span> <span class="p">]</span></pre></div>                                                  <p>Send streams feature</p>                            <div class="highlight"><pre>  <span class="nx">config</span><span class="p">.</span><span class="nx">sendStreams</span> <span class="o">=</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="s1">&#39;sendStreams&#39;</span> <span class="k">of</span> <span class="nx">config</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">config</span><span class="p">.</span><span class="nx">sendStreams</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
    <span class="nx">config</span><span class="p">.</span><span class="nx">sendStreams</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">config</span><span class="p">.</span><span class="nx">sendStreams</span> <span class="p">]</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">sendStreams</span> <span class="o">=</span> <span class="nx">outPorts</span> <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">async</span></pre></div>                                                  <p>Parameter ports</p>                            <div class="highlight"><pre>  <span class="nx">config</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="p">[]</span> <span class="nx">unless</span> <span class="s1">&#39;params&#39;</span> <span class="k">of</span> <span class="nx">config</span>
  <span class="nx">config</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="p">[</span> <span class="nx">config</span><span class="p">.</span><span class="nx">params</span> <span class="p">]</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">config</span><span class="p">.</span><span class="nx">params</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span></pre></div>                                                  <p>Node name</p>                            <div class="highlight"><pre>  <span class="nx">config</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="nx">unless</span> <span class="s1">&#39;name&#39;</span> <span class="k">of</span> <span class="nx">config</span></pre></div>                                                  <p>Drop premature input before all params are received</p>                            <div class="highlight"><pre>  <span class="nx">config</span><span class="p">.</span><span class="nx">dropInput</span> <span class="o">=</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="s1">&#39;dropInput&#39;</span> <span class="k">of</span> <span class="nx">config</span></pre></div>                                                  <p>Firing policy for addressable ports</p>                            <div class="highlight"><pre>  <span class="nx">unless</span> <span class="s1">&#39;arrayPolicy&#39;</span> <span class="k">of</span> <span class="nx">config</span>
    <span class="nx">config</span><span class="p">.</span><span class="nx">arrayPolicy</span> <span class="o">=</span>
      <span class="k">in</span><span class="o">:</span> <span class="s1">&#39;any&#39;</span>
      <span class="nv">params: </span><span class="s1">&#39;all&#39;</span></pre></div>                                                  <p>Garbage collector frequency: execute every N packets</p>                            <div class="highlight"><pre>  <span class="nx">config</span><span class="p">.</span><span class="nx">gcFrequency</span> <span class="o">=</span> <span class="mi">100</span> <span class="nx">unless</span> <span class="s1">&#39;gcFrequency&#39;</span> <span class="k">of</span> <span class="nx">config</span></pre></div>                                                  <p>Garbage collector timeout: drop packets older than N seconds</p>                            <div class="highlight"><pre>  <span class="nx">config</span><span class="p">.</span><span class="nx">gcTimeout</span> <span class="o">=</span> <span class="mi">300</span> <span class="nx">unless</span> <span class="s1">&#39;gcTimeout&#39;</span> <span class="k">of</span> <span class="nx">config</span>

  <span class="nx">collectGroups</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">forwardGroups</span></pre></div>                                                  <p>Collect groups from each port?</p>                            <div class="highlight"><pre>  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">collectGroups</span> <span class="o">is</span> <span class="s1">&#39;boolean&#39;</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">config</span><span class="p">.</span><span class="nx">group</span>
    <span class="nx">collectGroups</span> <span class="o">=</span> <span class="nx">inPorts</span></pre></div>                                                  <p>Collect groups from one and only port?</p>                            <div class="highlight"><pre>  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">collectGroups</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">config</span><span class="p">.</span><span class="nx">group</span>
    <span class="nx">collectGroups</span> <span class="o">=</span> <span class="p">[</span><span class="nx">collectGroups</span><span class="p">]</span></pre></div>                                                  <p>Collect groups from any port, as we group by them</p>                            <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">collectGroups</span> <span class="o">isnt</span> <span class="kc">false</span> <span class="o">and</span> <span class="nx">config</span><span class="p">.</span><span class="nx">group</span>
    <span class="nx">collectGroups</span> <span class="o">=</span> <span class="kc">true</span>

  <span class="k">for</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">inPorts</span>
    <span class="nx">unless</span> <span class="nx">component</span><span class="p">.</span><span class="nx">inPorts</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;no inPort named &#39;#{name}&#39;&quot;</span>
  <span class="k">for</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">outPorts</span>
    <span class="nx">unless</span> <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;no outPort named &#39;#{name}&#39;&quot;</span>

  <span class="nx">component</span><span class="p">.</span><span class="nx">groupedData</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="nx">component</span><span class="p">.</span><span class="nx">groupedGroups</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="nx">component</span><span class="p">.</span><span class="nx">groupedDisconnects</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="nx">disconnectOuts</span> <span class="o">=</span> <span class="o">-&gt;</span></pre></div>                                                  <p>Manual disconnect forwarding</p>                            <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">outPorts</span>
      <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span><span class="p">[</span><span class="nx">p</span><span class="p">].</span><span class="nx">disconnect</span><span class="p">()</span> <span class="k">if</span> <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span><span class="p">[</span><span class="nx">p</span><span class="p">].</span><span class="nx">isConnected</span><span class="p">()</span>

  <span class="nx">sendGroupToOuts</span> <span class="o">=</span> <span class="p">(</span><span class="nx">grp</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">outPorts</span>
      <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span><span class="p">[</span><span class="nx">p</span><span class="p">].</span><span class="nx">beginGroup</span> <span class="nx">grp</span>

  <span class="nx">closeGroupOnOuts</span> <span class="o">=</span> <span class="p">(</span><span class="nx">grp</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">outPorts</span>
      <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span><span class="p">[</span><span class="nx">p</span><span class="p">].</span><span class="nx">endGroup</span> <span class="nx">grp</span></pre></div>                                                  <p>For ordered output</p>                            <div class="highlight"><pre>  <span class="nx">component</span><span class="p">.</span><span class="nx">outputQ</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nx">processQueue</span> <span class="o">=</span> <span class="o">-&gt;</span>
    <span class="k">while</span> <span class="nx">component</span><span class="p">.</span><span class="nx">outputQ</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">streams</span> <span class="o">=</span> <span class="nx">component</span><span class="p">.</span><span class="nx">outputQ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nx">flushed</span> <span class="o">=</span> <span class="kc">false</span></pre></div>                                                  <p>Null in the queue means "disconnect all"</p>                            <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">streams</span> <span class="o">is</span> <span class="kc">null</span>
        <span class="nx">disconnectOuts</span><span class="p">()</span>
        <span class="nx">flushed</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="k">else</span></pre></div>                                                  <p>At least one of the outputs has to be resolved
for output streams to be flushed.</p>                            <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">outPorts</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span>
          <span class="nx">tmp</span> <span class="o">=</span> <span class="p">{}</span>
          <span class="nx">tmp</span><span class="p">[</span><span class="nx">outPorts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">streams</span>
          <span class="nx">streams</span> <span class="o">=</span> <span class="nx">tmp</span>
        <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">stream</span> <span class="k">of</span> <span class="nx">streams</span>
          <span class="k">if</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">resolved</span>
            <span class="nx">stream</span><span class="p">.</span><span class="nx">flush</span><span class="p">()</span>
            <span class="nx">flushed</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="nx">component</span><span class="p">.</span><span class="nx">outputQ</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span> <span class="k">if</span> <span class="nx">flushed</span>
      <span class="k">return</span> <span class="nx">unless</span> <span class="nx">flushed</span>

  <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">async</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">load</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="s1">&#39;load&#39;</span> <span class="k">of</span> <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span></pre></div>                                                  <p>Create before and after hooks</p>                            <div class="highlight"><pre>    <span class="nx">component</span><span class="p">.</span><span class="nx">beforeProcess</span> <span class="o">=</span> <span class="p">(</span><span class="nx">outs</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="nx">component</span><span class="p">.</span><span class="nx">outputQ</span><span class="p">.</span><span class="nx">push</span> <span class="nx">outs</span> <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">ordered</span>
      <span class="nx">component</span><span class="p">.</span><span class="nx">load</span><span class="o">++</span>
      <span class="k">if</span> <span class="s1">&#39;load&#39;</span> <span class="k">of</span> <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span> <span class="o">and</span> <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span><span class="p">.</span><span class="nx">load</span><span class="p">.</span><span class="nx">isAttached</span><span class="p">()</span>
        <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span><span class="p">.</span><span class="nx">load</span><span class="p">.</span><span class="nx">send</span> <span class="nx">component</span><span class="p">.</span><span class="nx">load</span>
        <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span><span class="p">.</span><span class="nx">load</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">()</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">afterProcess</span> <span class="o">=</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">outs</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="nx">processQueue</span><span class="p">()</span>
      <span class="nx">component</span><span class="p">.</span><span class="nx">load</span><span class="o">--</span>
      <span class="k">if</span> <span class="s1">&#39;load&#39;</span> <span class="k">of</span> <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span> <span class="o">and</span> <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span><span class="p">.</span><span class="nx">load</span><span class="p">.</span><span class="nx">isAttached</span><span class="p">()</span>
        <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span><span class="p">.</span><span class="nx">load</span><span class="p">.</span><span class="nx">send</span> <span class="nx">component</span><span class="p">.</span><span class="nx">load</span>
        <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span><span class="p">.</span><span class="nx">load</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">()</span></pre></div>                                                  <p>Parameter ports</p>                            <div class="highlight"><pre>  <span class="nx">component</span><span class="p">.</span><span class="nx">taskQ</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nx">component</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="nx">component</span><span class="p">.</span><span class="nx">requiredParams</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nx">component</span><span class="p">.</span><span class="nx">completeParams</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nx">component</span><span class="p">.</span><span class="nx">receivedParams</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nx">component</span><span class="p">.</span><span class="nx">defaultedParams</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nx">component</span><span class="p">.</span><span class="nx">defaultsSent</span> <span class="o">=</span> <span class="kc">false</span>

  <span class="nx">component</span><span class="p">.</span><span class="nx">sendDefaults</span> <span class="o">=</span> <span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">component</span><span class="p">.</span><span class="nx">defaultedParams</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="nx">param</span> <span class="k">in</span> <span class="nx">component</span><span class="p">.</span><span class="nx">defaultedParams</span>
        <span class="k">if</span> <span class="nx">component</span><span class="p">.</span><span class="nx">receivedParams</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">param</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>
          <span class="nx">tempSocket</span> <span class="o">=</span> <span class="nx">InternalSocket</span><span class="p">.</span><span class="nx">createSocket</span><span class="p">()</span>
          <span class="nx">component</span><span class="p">.</span><span class="nx">inPorts</span><span class="p">[</span><span class="nx">param</span><span class="p">].</span><span class="nx">attach</span> <span class="nx">tempSocket</span>
          <span class="nx">tempSocket</span><span class="p">.</span><span class="nx">send</span><span class="p">()</span>
          <span class="nx">tempSocket</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">()</span>
          <span class="nx">component</span><span class="p">.</span><span class="nx">inPorts</span><span class="p">[</span><span class="nx">param</span><span class="p">].</span><span class="nx">detach</span> <span class="nx">tempSocket</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">defaultsSent</span> <span class="o">=</span> <span class="kc">true</span>

  <span class="nx">resumeTaskQ</span> <span class="o">=</span> <span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">component</span><span class="p">.</span><span class="nx">completeParams</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="nx">component</span><span class="p">.</span><span class="nx">requiredParams</span><span class="p">.</span><span class="nx">length</span> <span class="o">and</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">taskQ</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>                                                  <p>Avoid looping when feeding the queue inside the queue itself</p>                            <div class="highlight"><pre>      <span class="nx">temp</span> <span class="o">=</span> <span class="nx">component</span><span class="p">.</span><span class="nx">taskQ</span><span class="p">.</span><span class="nx">slice</span> <span class="mi">0</span>
      <span class="nx">component</span><span class="p">.</span><span class="nx">taskQ</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">while</span> <span class="nx">temp</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nx">task</span> <span class="o">=</span> <span class="nx">temp</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
        <span class="nx">task</span><span class="p">()</span>
  <span class="k">for</span> <span class="nx">port</span> <span class="k">in</span> <span class="nx">config</span><span class="p">.</span><span class="nx">params</span>
    <span class="nx">unless</span> <span class="nx">component</span><span class="p">.</span><span class="nx">inPorts</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;no inPort named &#39;#{port}&#39;&quot;</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">requiredParams</span><span class="p">.</span><span class="nx">push</span> <span class="nx">port</span> <span class="k">if</span> <span class="nx">component</span><span class="p">.</span><span class="nx">inPorts</span><span class="p">[</span><span class="nx">port</span><span class="p">].</span><span class="nx">isRequired</span><span class="p">()</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">defaultedParams</span><span class="p">.</span><span class="nx">push</span> <span class="nx">port</span> <span class="k">if</span> <span class="nx">component</span><span class="p">.</span><span class="nx">inPorts</span><span class="p">[</span><span class="nx">port</span><span class="p">].</span><span class="nx">hasDefault</span><span class="p">()</span>
  <span class="k">for</span> <span class="nx">port</span> <span class="k">in</span> <span class="nx">config</span><span class="p">.</span><span class="nx">params</span>
    <span class="nx">do</span> <span class="p">(</span><span class="nx">port</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="nx">inPort</span> <span class="o">=</span> <span class="nx">component</span><span class="p">.</span><span class="nx">inPorts</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span>
      <span class="nx">inPort</span><span class="p">.</span><span class="nx">process</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">payload</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">-&gt;</span></pre></div>                                                  <p>Param ports only react on data</p>                            <div class="highlight"><pre>        <span class="k">return</span> <span class="nx">unless</span> <span class="nx">event</span> <span class="o">is</span> <span class="s1">&#39;data&#39;</span>
        <span class="k">if</span> <span class="nx">inPort</span><span class="p">.</span><span class="nx">isAddressable</span><span class="p">()</span>
          <span class="nx">component</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="nx">unless</span> <span class="nx">port</span> <span class="k">of</span> <span class="nx">component</span><span class="p">.</span><span class="nx">params</span>
          <span class="nx">component</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="nx">port</span><span class="p">][</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">payload</span>
          <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">arrayPolicy</span><span class="p">.</span><span class="nx">params</span> <span class="o">is</span> <span class="s1">&#39;all&#39;</span> <span class="o">and</span>
          <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">component</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="nx">port</span><span class="p">]).</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">inPort</span><span class="p">.</span><span class="nx">listAttached</span><span class="p">().</span><span class="nx">length</span>
            <span class="k">return</span> <span class="c1"># Need data on all array indexes to proceed</span>
        <span class="k">else</span>
          <span class="nx">component</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span> <span class="o">=</span> <span class="nx">payload</span>
        <span class="k">if</span> <span class="nx">component</span><span class="p">.</span><span class="nx">completeParams</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">port</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span> <span class="o">and</span>
        <span class="nx">component</span><span class="p">.</span><span class="nx">requiredParams</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">port</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
          <span class="nx">component</span><span class="p">.</span><span class="nx">completeParams</span><span class="p">.</span><span class="nx">push</span> <span class="nx">port</span>
        <span class="nx">component</span><span class="p">.</span><span class="nx">receivedParams</span><span class="p">.</span><span class="nx">push</span> <span class="nx">port</span></pre></div>                                                  <p>Trigger pending procs if all params are complete</p>                            <div class="highlight"><pre>        <span class="nx">resumeTaskQ</span><span class="p">()</span></pre></div>                                                  <p>Disconnect event forwarding</p>                            <div class="highlight"><pre>  <span class="nx">component</span><span class="p">.</span><span class="nx">disconnectData</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="nx">component</span><span class="p">.</span><span class="nx">disconnectQ</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="nx">component</span><span class="p">.</span><span class="nx">groupBuffers</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="nx">component</span><span class="p">.</span><span class="nx">keyBuffers</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="nx">component</span><span class="p">.</span><span class="nx">gcTimestamps</span> <span class="o">=</span> <span class="p">{}</span></pre></div>                                                  <p>Garbage collector</p>                            <div class="highlight"><pre>  <span class="nx">component</span><span class="p">.</span><span class="nx">dropRequest</span> <span class="o">=</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">-&gt;</span></pre></div>                                                  <p>Discard pending disconnect keys</p>                            <div class="highlight"><pre>    <span class="k">delete</span> <span class="nx">component</span><span class="p">.</span><span class="nx">disconnectData</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">if</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">component</span><span class="p">.</span><span class="nx">disconnectData</span></pre></div>                                                  <p>Clean grouped data</p>                            <div class="highlight"><pre>    <span class="k">delete</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupedData</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">if</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupedData</span>
    <span class="k">delete</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupedGroups</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">if</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupedGroups</span>

  <span class="nx">component</span><span class="p">.</span><span class="nx">gcCounter</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="nx">gc</span> <span class="o">=</span> <span class="o">-&gt;</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">gcCounter</span><span class="o">++</span>
    <span class="k">if</span> <span class="nx">component</span><span class="p">.</span><span class="nx">gcCounter</span> <span class="o">%</span> <span class="nx">config</span><span class="p">.</span><span class="nx">gcFrequency</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="nx">current</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span>
      <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span> <span class="k">of</span> <span class="nx">component</span><span class="p">.</span><span class="nx">gcTimestamps</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">current</span> <span class="o">-</span> <span class="nx">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">gcTimeout</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
          <span class="nx">component</span><span class="p">.</span><span class="nx">dropRequest</span> <span class="nx">key</span>
          <span class="k">delete</span> <span class="nx">component</span><span class="p">.</span><span class="nx">gcTimestamps</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span></pre></div>                                                  <p>Grouped ports</p>                            <div class="highlight"><pre>  <span class="k">for</span> <span class="nx">port</span> <span class="k">in</span> <span class="nx">inPorts</span>
    <span class="nx">do</span> <span class="p">(</span><span class="nx">port</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="nx">component</span><span class="p">.</span><span class="nx">groupBuffers</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="nx">component</span><span class="p">.</span><span class="nx">keyBuffers</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span></pre></div>                                                  <p>Support for StreamReceiver ports</p>                            <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">receiveStreams</span> <span class="o">and</span> <span class="nx">config</span><span class="p">.</span><span class="nx">receiveStreams</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">port</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nx">inPort</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StreamReceiver</span> <span class="nx">component</span><span class="p">.</span><span class="nx">inPorts</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="nx">inPort</span> <span class="o">=</span> <span class="nx">component</span><span class="p">.</span><span class="nx">inPorts</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span>

      <span class="nx">needPortGroups</span> <span class="o">=</span> <span class="nx">collectGroups</span> <span class="k">instanceof</span> <span class="nb">Array</span> <span class="o">and</span> <span class="nx">collectGroups</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">port</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span></pre></div>                                                  <p>Set processing callback</p>                            <div class="highlight"><pre>      <span class="nx">inPort</span><span class="p">.</span><span class="nx">process</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">payload</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">-&gt;</span>
        <span class="nx">component</span><span class="p">.</span><span class="nx">groupBuffers</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="nx">unless</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupBuffers</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span>
        <span class="k">switch</span> <span class="nx">event</span>
          <span class="k">when</span> <span class="s1">&#39;begingroup&#39;</span>
            <span class="nx">component</span><span class="p">.</span><span class="nx">groupBuffers</span><span class="p">[</span><span class="nx">port</span><span class="p">].</span><span class="nx">push</span> <span class="nx">payload</span>
            <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">forwardGroups</span> <span class="o">and</span> <span class="p">(</span><span class="nx">collectGroups</span> <span class="o">is</span> <span class="kc">true</span> <span class="o">or</span> <span class="nx">needPortGroups</span><span class="p">)</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">config</span><span class="p">.</span><span class="nx">async</span>
              <span class="nx">sendGroupToOuts</span> <span class="nx">payload</span>
          <span class="k">when</span> <span class="s1">&#39;endgroup&#39;</span>
            <span class="nx">component</span><span class="p">.</span><span class="nx">groupBuffers</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span> <span class="o">=</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupBuffers</span><span class="p">[</span><span class="nx">port</span><span class="p">].</span><span class="nx">slice</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupBuffers</span><span class="p">[</span><span class="nx">port</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">forwardGroups</span> <span class="o">and</span> <span class="p">(</span><span class="nx">collectGroups</span> <span class="o">is</span> <span class="kc">true</span> <span class="o">or</span> <span class="nx">needPortGroups</span><span class="p">)</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">config</span><span class="p">.</span><span class="nx">async</span>
              <span class="nx">closeGroupOnOuts</span> <span class="nx">payload</span>
          <span class="k">when</span> <span class="s1">&#39;disconnect&#39;</span>
            <span class="k">if</span> <span class="nx">inPorts</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span>
              <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">async</span> <span class="o">or</span> <span class="nx">config</span><span class="p">.</span><span class="nx">StreamSender</span>
                <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">ordered</span>
                  <span class="nx">component</span><span class="p">.</span><span class="nx">outputQ</span><span class="p">.</span><span class="nx">push</span> <span class="kc">null</span>
                  <span class="nx">processQueue</span><span class="p">()</span>
                <span class="k">else</span>
                  <span class="nx">component</span><span class="p">.</span><span class="nx">disconnectQ</span><span class="p">.</span><span class="nx">push</span> <span class="kc">true</span>
              <span class="k">else</span>
                <span class="nx">disconnectOuts</span><span class="p">()</span>
            <span class="k">else</span>
              <span class="nx">foundGroup</span> <span class="o">=</span> <span class="kc">false</span>
              <span class="nx">key</span> <span class="o">=</span> <span class="nx">component</span><span class="p">.</span><span class="nx">keyBuffers</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span>
              <span class="nx">component</span><span class="p">.</span><span class="nx">disconnectData</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="nx">unless</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">component</span><span class="p">.</span><span class="nx">disconnectData</span>
              <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">component</span><span class="p">.</span><span class="nx">disconnectData</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">length</span><span class="p">]</span>
                <span class="nx">unless</span> <span class="nx">port</span> <span class="k">of</span> <span class="nx">component</span><span class="p">.</span><span class="nx">disconnectData</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span>
                  <span class="nx">foundGroup</span> <span class="o">=</span> <span class="kc">true</span>
                  <span class="nx">component</span><span class="p">.</span><span class="nx">disconnectData</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="nx">port</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
                  <span class="k">if</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">component</span><span class="p">.</span><span class="nx">disconnectData</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="nx">i</span><span class="p">]).</span><span class="nx">length</span> <span class="o">is</span> <span class="nx">inPorts</span><span class="p">.</span><span class="nx">length</span>
                    <span class="nx">component</span><span class="p">.</span><span class="nx">disconnectData</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">shift</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">async</span> <span class="o">or</span> <span class="nx">config</span><span class="p">.</span><span class="nx">StreamSender</span>
                      <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">ordered</span>
                        <span class="nx">component</span><span class="p">.</span><span class="nx">outputQ</span><span class="p">.</span><span class="nx">push</span> <span class="kc">null</span>
                        <span class="nx">processQueue</span><span class="p">()</span>
                      <span class="k">else</span>
                        <span class="nx">component</span><span class="p">.</span><span class="nx">disconnectQ</span><span class="p">.</span><span class="nx">push</span> <span class="kc">true</span>
                    <span class="k">else</span>
                      <span class="nx">disconnectOuts</span><span class="p">()</span>
                    <span class="k">delete</span> <span class="nx">component</span><span class="p">.</span><span class="nx">disconnectData</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">if</span> <span class="nx">component</span><span class="p">.</span><span class="nx">disconnectData</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
                  <span class="k">break</span>
              <span class="nx">unless</span> <span class="nx">foundGroup</span>
                <span class="nx">obj</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nx">obj</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
                <span class="nx">component</span><span class="p">.</span><span class="nx">disconnectData</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">push</span> <span class="nx">obj</span>

          <span class="k">when</span> <span class="s1">&#39;data&#39;</span>
            <span class="k">if</span> <span class="nx">inPorts</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">inPort</span><span class="p">.</span><span class="nx">isAddressable</span><span class="p">()</span>
              <span class="nx">data</span> <span class="o">=</span> <span class="nx">payload</span>
              <span class="nx">groups</span> <span class="o">=</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupBuffers</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span>
            <span class="k">else</span>
              <span class="nx">key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
              <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">group</span> <span class="o">and</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupBuffers</span><span class="p">[</span><span class="nx">port</span><span class="p">].</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="nx">key</span> <span class="o">=</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupBuffers</span><span class="p">[</span><span class="nx">port</span><span class="p">].</span><span class="nx">toString</span><span class="p">()</span>
                <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">group</span> <span class="k">instanceof</span> <span class="nb">RegExp</span>
                  <span class="nx">reqId</span> <span class="o">=</span> <span class="kc">null</span>
                  <span class="k">for</span> <span class="nx">grp</span> <span class="k">in</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupBuffers</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">group</span><span class="p">.</span><span class="nx">test</span> <span class="nx">grp</span>
                      <span class="nx">reqId</span> <span class="o">=</span> <span class="nx">grp</span>
                      <span class="k">break</span>
                  <span class="nx">key</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">reqId</span> <span class="k">then</span> <span class="nx">reqId</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
              <span class="k">else</span> <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">field</span> <span class="o">and</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;object&#39;</span> <span class="o">and</span>
              <span class="nx">config</span><span class="p">.</span><span class="nx">field</span> <span class="k">of</span> <span class="nx">payload</span>
                <span class="nx">key</span> <span class="o">=</span> <span class="nx">payload</span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">field</span><span class="p">]</span>
              <span class="nx">component</span><span class="p">.</span><span class="nx">keyBuffers</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span> <span class="o">=</span> <span class="nx">key</span>

              <span class="nx">component</span><span class="p">.</span><span class="nx">groupedData</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="nx">unless</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupedData</span>
              <span class="nx">component</span><span class="p">.</span><span class="nx">groupedGroups</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="nx">unless</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupedGroups</span>
              <span class="nx">foundGroup</span> <span class="o">=</span> <span class="kc">false</span>
              <span class="nx">requiredLength</span> <span class="o">=</span> <span class="nx">inPorts</span><span class="p">.</span><span class="nx">length</span>
              <span class="o">++</span><span class="nx">requiredLength</span> <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">field</span></pre></div>                                                  <p>Check buffered tuples awaiting completion</p>                            <div class="highlight"><pre>              <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">component</span><span class="p">.</span><span class="nx">groupedData</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">length</span><span class="p">]</span></pre></div>                                                  <p>Check this buffered tuple if it's missing value for this port</p>                            <div class="highlight"><pre>                <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">port</span> <span class="k">of</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupedData</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="nx">i</span><span class="p">])</span> <span class="o">or</span>
                <span class="p">(</span><span class="nx">component</span><span class="p">.</span><span class="nx">inPorts</span><span class="p">[</span><span class="nx">port</span><span class="p">].</span><span class="nx">isAddressable</span><span class="p">()</span> <span class="o">and</span>
                <span class="nx">config</span><span class="p">.</span><span class="nx">arrayPolicy</span><span class="p">.</span><span class="k">in</span> <span class="o">is</span> <span class="s1">&#39;all&#39;</span> <span class="o">and</span>
                <span class="o">not</span> <span class="p">(</span><span class="nx">index</span> <span class="k">of</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupedData</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="nx">port</span><span class="p">]))</span>
                  <span class="nx">foundGroup</span> <span class="o">=</span> <span class="kc">true</span>
                  <span class="k">if</span> <span class="nx">component</span><span class="p">.</span><span class="nx">inPorts</span><span class="p">[</span><span class="nx">port</span><span class="p">].</span><span class="nx">isAddressable</span><span class="p">()</span></pre></div>                                                  <p>Maintain indexes for addressable ports</p>                            <div class="highlight"><pre>                    <span class="nx">unless</span> <span class="nx">port</span> <span class="k">of</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupedData</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span>
                      <span class="nx">component</span><span class="p">.</span><span class="nx">groupedData</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="nx">port</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="nx">component</span><span class="p">.</span><span class="nx">groupedData</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="nx">port</span><span class="p">][</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">payload</span>
                  <span class="k">else</span>
                    <span class="nx">component</span><span class="p">.</span><span class="nx">groupedData</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="nx">port</span><span class="p">]</span> <span class="o">=</span> <span class="nx">payload</span>
                  <span class="k">if</span> <span class="nx">needPortGroups</span></pre></div>                                                  <p>Include port groups into the set of the unique ones</p>                            <div class="highlight"><pre>                    <span class="nx">component</span><span class="p">.</span><span class="nx">groupedGroups</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">union</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupedGroups</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="nx">i</span><span class="p">],</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupBuffers</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span>
                  <span class="k">else</span> <span class="k">if</span> <span class="nx">collectGroups</span> <span class="o">is</span> <span class="kc">true</span></pre></div>                                                  <p>All the groups we need are here in this port</p>                            <div class="highlight"><pre>                    <span class="nx">component</span><span class="p">.</span><span class="nx">groupedGroups</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="nx">port</span><span class="p">]</span> <span class="o">=</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupBuffers</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span></pre></div>                                                  <p>Addressable ports may require other indexes</p>                            <div class="highlight"><pre>                  <span class="k">if</span> <span class="nx">component</span><span class="p">.</span><span class="nx">inPorts</span><span class="p">[</span><span class="nx">port</span><span class="p">].</span><span class="nx">isAddressable</span><span class="p">()</span> <span class="o">and</span>
                  <span class="nx">config</span><span class="p">.</span><span class="nx">arrayPolicy</span><span class="p">.</span><span class="k">in</span> <span class="o">is</span> <span class="s1">&#39;all&#39;</span> <span class="o">and</span>
                  <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">component</span><span class="p">.</span><span class="nx">groupedData</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="nx">port</span><span class="p">]).</span><span class="nx">length</span> <span class="o">&lt;</span>
                  <span class="nx">component</span><span class="p">.</span><span class="nx">inPorts</span><span class="p">[</span><span class="nx">port</span><span class="p">].</span><span class="nx">listAttached</span><span class="p">().</span><span class="nx">length</span>
                    <span class="k">return</span> <span class="c1"># Need data on other array port indexes to arrive</span>

                  <span class="nx">groupLength</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">component</span><span class="p">.</span><span class="nx">groupedData</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="nx">i</span><span class="p">]).</span><span class="nx">length</span></pre></div>                                                  <p>Check if the tuple is complete</p>                            <div class="highlight"><pre>                  <span class="k">if</span> <span class="nx">groupLength</span> <span class="o">is</span> <span class="nx">requiredLength</span>
                    <span class="nx">data</span> <span class="o">=</span> <span class="p">(</span><span class="nx">component</span><span class="p">.</span><span class="nx">groupedData</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">splice</span> <span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></pre></div>                                                  <p>Strip port name if there's only one inport</p>                            <div class="highlight"><pre>                    <span class="k">if</span> <span class="nx">inPorts</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">inPort</span><span class="p">.</span><span class="nx">isAddressable</span><span class="p">()</span>
                      <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span>
                    <span class="nx">groups</span> <span class="o">=</span> <span class="p">(</span><span class="nx">component</span><span class="p">.</span><span class="nx">groupedGroups</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">splice</span> <span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nx">collectGroups</span> <span class="o">is</span> <span class="kc">true</span>
                      <span class="nx">groups</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">intersection</span><span class="p">.</span><span class="nx">apply</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">values</span> <span class="nx">groups</span>
                    <span class="k">delete</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupedData</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">if</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupedData</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
                    <span class="k">delete</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupedGroups</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">if</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupedGroups</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">group</span> <span class="o">and</span> <span class="nx">key</span>
                      <span class="k">delete</span> <span class="nx">component</span><span class="p">.</span><span class="nx">gcTimestamps</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
                    <span class="k">break</span>
                  <span class="k">else</span>
                    <span class="k">return</span> <span class="c1"># need more data to continue</span>
              <span class="nx">unless</span> <span class="nx">foundGroup</span></pre></div>                                                  <p>Create a new tuple</p>                            <div class="highlight"><pre>                <span class="nx">obj</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nx">obj</span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">field</span><span class="p">]</span> <span class="o">=</span> <span class="nx">key</span> <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">field</span>
                <span class="k">if</span> <span class="nx">component</span><span class="p">.</span><span class="nx">inPorts</span><span class="p">[</span><span class="nx">port</span><span class="p">].</span><span class="nx">isAddressable</span><span class="p">()</span>
                  <span class="nx">obj</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">;</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">port</span><span class="p">][</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">payload</span>
                <span class="k">else</span>
                  <span class="nx">obj</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span> <span class="o">=</span> <span class="nx">payload</span>
                <span class="k">if</span> <span class="nx">inPorts</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">and</span>
                <span class="nx">component</span><span class="p">.</span><span class="nx">inPorts</span><span class="p">[</span><span class="nx">port</span><span class="p">].</span><span class="nx">isAddressable</span><span class="p">()</span> <span class="o">and</span>
                <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">arrayPolicy</span><span class="p">.</span><span class="k">in</span> <span class="o">is</span> <span class="s1">&#39;any&#39;</span> <span class="o">or</span>
                <span class="nx">component</span><span class="p">.</span><span class="nx">inPorts</span><span class="p">[</span><span class="nx">port</span><span class="p">].</span><span class="nx">listAttached</span><span class="p">().</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span><span class="p">)</span></pre></div>                                                  <p>This packet is all we need</p>                            <div class="highlight"><pre>                  <span class="nx">data</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span>
                  <span class="nx">groups</span> <span class="o">=</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupBuffers</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span>
                <span class="k">else</span>
                  <span class="nx">component</span><span class="p">.</span><span class="nx">groupedData</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">push</span> <span class="nx">obj</span>
                  <span class="k">if</span> <span class="nx">needPortGroups</span>
                    <span class="nx">component</span><span class="p">.</span><span class="nx">groupedGroups</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">push</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupBuffers</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span>
                  <span class="k">else</span> <span class="k">if</span> <span class="nx">collectGroups</span> <span class="o">is</span> <span class="kc">true</span>
                    <span class="nx">tmp</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">;</span> <span class="nx">tmp</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span> <span class="o">=</span> <span class="nx">component</span><span class="p">.</span><span class="nx">groupBuffers</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span>
                    <span class="nx">component</span><span class="p">.</span><span class="nx">groupedGroups</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">push</span> <span class="nx">tmp</span>
                  <span class="k">else</span>
                    <span class="nx">component</span><span class="p">.</span><span class="nx">groupedGroups</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">push</span> <span class="p">[]</span>
                  <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">group</span> <span class="o">and</span> <span class="nx">key</span></pre></div>                                                  <p>Timestamp to garbage collect this request</p>                            <div class="highlight"><pre>                    <span class="nx">component</span><span class="p">.</span><span class="nx">gcTimestamps</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span>
                  <span class="k">return</span> <span class="c1"># need more data to continue</span></pre></div>                                                  <p>Drop premature data if configured to do so</p>                            <div class="highlight"><pre>            <span class="k">return</span> <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">dropInput</span> <span class="o">and</span> <span class="nx">component</span><span class="p">.</span><span class="nx">completeParams</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="nx">component</span><span class="p">.</span><span class="nx">requiredParams</span><span class="p">.</span><span class="nx">length</span></pre></div>                                                  <p>Prepare outputs</p>                            <div class="highlight"><pre>            <span class="nx">outs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">outPorts</span>
              <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">async</span> <span class="o">or</span> <span class="nx">config</span><span class="p">.</span><span class="nx">sendStreams</span> <span class="o">and</span>
              <span class="nx">config</span><span class="p">.</span><span class="nx">sendStreams</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
                <span class="nx">outs</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">StreamSender</span> <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span><span class="p">[</span><span class="nx">name</span><span class="p">],</span> <span class="nx">config</span><span class="p">.</span><span class="nx">ordered</span>
              <span class="k">else</span>
                <span class="nx">outs</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>

            <span class="nx">outs</span> <span class="o">=</span> <span class="nx">outs</span><span class="p">[</span><span class="nx">outPorts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nx">outPorts</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="c1"># for simplicity</span>
            <span class="nx">groups</span> <span class="o">=</span> <span class="p">[]</span> <span class="nx">unless</span> <span class="nx">groups</span>
            <span class="nx">whenDoneGroups</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">.</span><span class="nx">slice</span> <span class="mi">0</span>
            <span class="nx">whenDone</span> <span class="o">=</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">-&gt;</span>
              <span class="k">if</span> <span class="nx">err</span>
                <span class="nx">component</span><span class="p">.</span><span class="nx">error</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">whenDoneGroups</span></pre></div>                                                  <p>For use with MultiError trait</p>                            <div class="highlight"><pre>              <span class="k">if</span> <span class="k">typeof</span> <span class="nx">component</span><span class="p">.</span><span class="nx">fail</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span> <span class="o">and</span> <span class="nx">component</span><span class="p">.</span><span class="nx">hasErrors</span>
                <span class="nx">component</span><span class="p">.</span><span class="nx">fail</span><span class="p">()</span></pre></div>                                                  <p>Disconnect outputs if still connected,
this also indicates them as resolved if pending</p>                            <div class="highlight"><pre>              <span class="nx">outputs</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">outPorts</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="nv">port: </span><span class="nx">outs</span> <span class="k">else</span> <span class="nx">outs</span>
              <span class="nx">disconnect</span> <span class="o">=</span> <span class="kc">false</span>
              <span class="k">if</span> <span class="nx">component</span><span class="p">.</span><span class="nx">disconnectQ</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="nx">component</span><span class="p">.</span><span class="nx">disconnectQ</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
                <span class="nx">disconnect</span> <span class="o">=</span> <span class="kc">true</span>
              <span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">out</span> <span class="k">of</span> <span class="nx">outputs</span>
                <span class="nx">out</span><span class="p">.</span><span class="nx">endGroup</span><span class="p">()</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">whenDoneGroups</span> <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">forwardGroups</span> <span class="o">and</span> <span class="nx">config</span><span class="p">.</span><span class="nx">async</span>
                <span class="nx">out</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">()</span> <span class="k">if</span> <span class="nx">disconnect</span>
                <span class="nx">out</span><span class="p">.</span><span class="nx">done</span><span class="p">()</span> <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">async</span> <span class="o">or</span> <span class="nx">config</span><span class="p">.</span><span class="nx">StreamSender</span>
              <span class="k">if</span> <span class="k">typeof</span> <span class="nx">component</span><span class="p">.</span><span class="nx">afterProcess</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
                <span class="nx">component</span><span class="p">.</span><span class="nx">afterProcess</span> <span class="nx">err</span> <span class="o">or</span> <span class="nx">component</span><span class="p">.</span><span class="nx">hasErrors</span><span class="p">,</span> <span class="nx">outs</span></pre></div>                                                  <p>Before hook</p>                            <div class="highlight"><pre>            <span class="k">if</span> <span class="k">typeof</span> <span class="nx">component</span><span class="p">.</span><span class="nx">beforeProcess</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
              <span class="nx">component</span><span class="p">.</span><span class="nx">beforeProcess</span> <span class="nx">outs</span></pre></div>                                                  <p>Group forwarding</p>                            <div class="highlight"><pre>            <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">forwardGroups</span> <span class="o">and</span> <span class="nx">config</span><span class="p">.</span><span class="nx">async</span>
              <span class="k">if</span> <span class="nx">outPorts</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span>
                <span class="nx">outs</span><span class="p">.</span><span class="nx">beginGroup</span> <span class="nx">g</span> <span class="k">for</span> <span class="nx">g</span> <span class="k">in</span> <span class="nx">groups</span>
              <span class="k">else</span>
                <span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">out</span> <span class="k">of</span> <span class="nx">outs</span>
                  <span class="nx">out</span><span class="p">.</span><span class="nx">beginGroup</span> <span class="nx">g</span> <span class="k">for</span> <span class="nx">g</span> <span class="k">in</span> <span class="nx">groups</span></pre></div>                                                  <p>Enforce MultiError with WirePattern (for group forwarding)</p>                            <div class="highlight"><pre>            <span class="nx">exports</span><span class="p">.</span><span class="nx">MultiError</span> <span class="nx">component</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">error</span><span class="p">,</span> <span class="nx">groups</span></pre></div>                                                  <p>Call the proc function</p>                            <div class="highlight"><pre>            <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">async</span>
              <span class="nx">postpone</span> <span class="o">=</span> <span class="o">-&gt;</span>
              <span class="nx">resume</span> <span class="o">=</span> <span class="o">-&gt;</span>
              <span class="nx">postponedToQ</span> <span class="o">=</span> <span class="kc">false</span>
              <span class="nx">task</span> <span class="o">=</span> <span class="o">-&gt;</span>
                <span class="nx">proc</span><span class="p">.</span><span class="nx">call</span> <span class="nx">component</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">groups</span><span class="p">,</span> <span class="nx">outs</span><span class="p">,</span> <span class="nx">whenDone</span><span class="p">,</span> <span class="nx">postpone</span><span class="p">,</span> <span class="nx">resume</span>
              <span class="nx">postpone</span> <span class="o">=</span> <span class="p">(</span><span class="nx">backToQueue</span> <span class="o">=</span> <span class="kc">true</span><span class="p">)</span> <span class="o">-&gt;</span>
                <span class="nx">postponedToQ</span> <span class="o">=</span> <span class="nx">backToQueue</span>
                <span class="k">if</span> <span class="nx">backToQueue</span>
                  <span class="nx">component</span><span class="p">.</span><span class="nx">taskQ</span><span class="p">.</span><span class="nx">push</span> <span class="nx">task</span>
              <span class="nx">resume</span> <span class="o">=</span> <span class="o">-&gt;</span>
                <span class="k">if</span> <span class="nx">postponedToQ</span> <span class="k">then</span> <span class="nx">resumeTaskQ</span><span class="p">()</span> <span class="k">else</span> <span class="nx">task</span><span class="p">()</span>
            <span class="k">else</span>
              <span class="nx">task</span> <span class="o">=</span> <span class="o">-&gt;</span>
                <span class="nx">proc</span><span class="p">.</span><span class="nx">call</span> <span class="nx">component</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">groups</span><span class="p">,</span> <span class="nx">outs</span>
                <span class="nx">whenDone</span><span class="p">()</span>
            <span class="nx">component</span><span class="p">.</span><span class="nx">taskQ</span><span class="p">.</span><span class="nx">push</span> <span class="nx">task</span>
            <span class="nx">resumeTaskQ</span><span class="p">()</span></pre></div>                                                  <p>Call the garbage collector</p>                            <div class="highlight"><pre>            <span class="nx">gc</span><span class="p">()</span></pre></div>                                                  <p>Overload shutdown method to clean WirePattern state</p>                            <div class="highlight"><pre>  <span class="nx">baseShutdown</span> <span class="o">=</span> <span class="nx">component</span><span class="p">.</span><span class="nx">shutdown</span>
  <span class="nx">component</span><span class="p">.</span><span class="nx">shutdown</span> <span class="o">=</span> <span class="o">-&gt;</span>
    <span class="nx">baseShutdown</span><span class="p">.</span><span class="nx">call</span> <span class="nx">component</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">groupedData</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">groupedGroups</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">outputQ</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">disconnectData</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">disconnectQ</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">taskQ</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">completeParams</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">receivedParams</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">defaultsSent</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">groupBuffers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">keyBuffers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">gcTimestamps</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">gcCounter</span> <span class="o">=</span> <span class="mi">0</span></pre></div>                                                  <p>Make it chainable or usable at the end of getComponent()</p>                            <div class="highlight"><pre>  <span class="k">return</span> <span class="nx">component</span></pre></div>                                                  <p>Alias for compatibility with 0.5.3</p>                            <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">GroupedInput</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">WirePattern</span></pre></div>                                                  <p><code>CustomError</code> returns an <code>Error</code> object carrying additional properties.</p>                            <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">CustomError</span> <span class="o">=</span> <span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nx">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span> <span class="nx">message</span>
  <span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">CustomizeError</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">options</span></pre></div>                                                  <p><code>CustomizeError</code> sets additional options for an <code>Error</code> object.</p>                            <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">CustomizeError</span> <span class="o">=</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span> <span class="k">of</span> <span class="nx">options</span>
    <span class="nx">err</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>
  <span class="k">return</span> <span class="nx">err</span></pre></div>                                                  <p><code>MultiError</code> simplifies throwing and handling multiple error objects
during a single component activation.</p>

<p><code>group</code> is an optional group ID which will be used to wrap all error
packets emitted by the component.</p>                            <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">MultiError</span> <span class="o">=</span> <span class="p">(</span><span class="nx">component</span><span class="p">,</span> <span class="nx">group</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">errorPort</span> <span class="o">=</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">forwardedGroups</span> <span class="o">=</span> <span class="p">[])</span> <span class="o">-&gt;</span>
  <span class="nx">component</span><span class="p">.</span><span class="nx">hasErrors</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="nx">component</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="p">[]</span></pre></div>                                                  <p>Override component.error to support group information</p>                            <div class="highlight"><pre>  <span class="nx">component</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">groups</span> <span class="o">=</span> <span class="p">[])</span> <span class="o">-&gt;</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">push</span>
      <span class="nv">err: </span><span class="nx">e</span>
      <span class="nv">groups: </span><span class="nx">forwardedGroups</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">groups</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">hasErrors</span> <span class="o">=</span> <span class="kc">true</span></pre></div>                                                  <p>Fail method should be called to terminate process immediately
or to flush error packets.</p>                            <div class="highlight"><pre>  <span class="nx">component</span><span class="p">.</span><span class="nx">fail</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">groups</span> <span class="o">=</span> <span class="p">[])</span> <span class="o">-&gt;</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">error</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">groups</span> <span class="k">if</span> <span class="nx">e</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">component</span><span class="p">.</span><span class="nx">hasErrors</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">errorPort</span> <span class="k">of</span> <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span><span class="p">[</span><span class="nx">errorPort</span><span class="p">].</span><span class="nx">isAttached</span><span class="p">()</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span><span class="p">[</span><span class="nx">errorPort</span><span class="p">].</span><span class="nx">beginGroup</span> <span class="nx">group</span> <span class="k">if</span> <span class="nx">group</span>
    <span class="k">for</span> <span class="nx">error</span> <span class="k">in</span> <span class="nx">component</span><span class="p">.</span><span class="nx">errors</span>
      <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span><span class="p">[</span><span class="nx">errorPort</span><span class="p">].</span><span class="nx">beginGroup</span> <span class="nx">grp</span> <span class="k">for</span> <span class="nx">grp</span> <span class="k">in</span> <span class="nx">error</span><span class="p">.</span><span class="nx">groups</span>
      <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span><span class="p">[</span><span class="nx">errorPort</span><span class="p">].</span><span class="nx">send</span> <span class="nx">error</span><span class="p">.</span><span class="nx">err</span>
      <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span><span class="p">[</span><span class="nx">errorPort</span><span class="p">].</span><span class="nx">endGroup</span><span class="p">()</span> <span class="k">for</span> <span class="nx">grp</span> <span class="k">in</span> <span class="nx">error</span><span class="p">.</span><span class="nx">groups</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span><span class="p">[</span><span class="nx">errorPort</span><span class="p">].</span><span class="nx">endGroup</span><span class="p">()</span> <span class="k">if</span> <span class="nx">group</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">outPorts</span><span class="p">[</span><span class="nx">errorPort</span><span class="p">].</span><span class="nx">disconnect</span><span class="p">()</span></pre></div>                                                  <p>Clean the status for next activation</p>                            <div class="highlight"><pre>    <span class="nx">component</span><span class="p">.</span><span class="nx">hasErrors</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="p">[]</span></pre></div>                                                  <p>Overload shutdown method to clear errors</p>                            <div class="highlight"><pre>  <span class="nx">baseShutdown</span> <span class="o">=</span> <span class="nx">component</span><span class="p">.</span><span class="nx">shutdown</span>
  <span class="nx">component</span><span class="p">.</span><span class="nx">shutdown</span> <span class="o">=</span> <span class="o">-&gt;</span>
    <span class="nx">baseShutdown</span><span class="p">.</span><span class="nx">call</span> <span class="nx">component</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">hasErrors</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">component</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">return</span> <span class="nx">component</span>

</pre></div>                                   <p><small>This page contains documentation generated automatically on 2016-06-02 from NoFlo's <a href="https://github.com/noflo/noflo/blob/master/src/lib/Helpers.coffee">Helpers.coffee</a> file.</small></p>         </div>       </div>     </div>   </div> 